version: '3'

# edit template.env and save as .env before running docker-compose

services:
  backdrop:
    build: .
    image: backdrop:apache
    container_name: backdrop
    restart: unless-stopped
    ports:
      - ${BACKDROP_PORT}:80 
    volumes:
      - ./shared/html/files:/var/www/html/files
      - ./shared/html/sites:/var/www/html/sites
      - ./shared/html/layouts:/var/www/html/layouts
      - ./shared/html/modules:/var/www/html/modules
      - ./shared/html/themes:/var/www/html/themes
    environment:
      BACKDROP_DB_HOST: "${BACKDROP_DB_HOST}"
      BACKDROP_DB_PORT: "${BACKDROP_DB_PORT}"
      BACKDROP_DB_NAME: "${BACKDROP_DB_NAME}"
      BACKDROP_DB_USER: "${BACKDROP_DB_USER}"
      BACKDROP_DB_PASSWORD: "${BACKDROP_DB_USER_PASSWORD}"
    depends_on:
      - backdrop-db
    
  pma:
    platform: linux/x86_64
    image: phpmyadmin/phpmyadmin:latest
    container_name: backdrop_pma
    environment:
      PMA_HOST: "${BACKDROP_DB_HOST}"
      PMA_PORT: "${BACKDROP_DB_PORT}"
      MYSQL_ROOT_PASSWORD: "${BACKDROP_DB_ROOT_PASSWORD}"
    ports:
      - ${BACKDROP_PHPMYADMIN_PORT}:80
    depends_on:
      - backdrop-db

  backdrop-db:
    image: mariadb:latest
    container_name: ${BACKDROP_DB_HOST}
    ports:
      - ${BACKDROP_DB_PORT}:3306
    volumes:
      - ./shared/db:/var/lib/mysql
      - ./custom-mysql.conf:/etc/mysql/conf.d/custom.cnf
    environment:
      MYSQL_DATABASE: "${BACKDROP_DB_NAME}"
      MYSQL_ROOT_PASSWORD: "${BACKDROP_DB_ROOT_PASSWORD}"
      MYSQL_USER: "${BACKDROP_DB_USER}"
      MYSQL_PASSWORD: "${BACKDROP_DB_USER_PASSWORD}"

networks:
  default:
    external:
      name: web
